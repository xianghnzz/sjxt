import{r as e,t,aa as l,af as s,ag as i,ah as r,o,c as a,w as n,e as c,a as d,b as u,u as p,d as f,p as _,l as g,m as h,F as x,v as y,n as b,s as m,y as v,h as w,i as $,g as k,j,_ as I,Z as P}from"./index-855f89f9.js";import{_ as C}from"./tui-modal.dd985726.js";import{a as O,o as T,b as F,r as N}from"./uni-app.es.8f4863ce.js";import{_ as S}from"./back_bai.3f7a0c49.js";import{_ as J,a as L}from"./add.95838ac7.js";import{_ as U}from"./gg.7b849707.js";import{_ as E}from"./_plugin-vue_export-helper.1b428a4d.js";const B=E({__name:"product-book-free-edit",setup(E){const B=e({triggered:!1,product_print_list:[],bili:1,showModal:0,configsInfo:{},configsInfo2:{configs_value:""},cItem:{},cIndex:0,coverPage:{pages_id:"",pages_cover:"",pages_content:{bgImg:"",imgList:[]}},endPage:{pages_id:"",pages_cover:"",pages_content:{bgImg:"",imgList:[]}}}),{triggered:M,product_print_list:z,bili:q,showModal:H,configsInfo:A,configsInfo2:G,cItem:Z,cIndex:D,coverPage:K,endPage:Q}=t(B),R=l((()=>m.state.userInfo)),V=l((()=>m.state.orderFrom)),W=l((()=>{var e,t;return 1==(null==(t=null==(e=V.value)?void 0:e.order_commodity_info_obj)?void 0:t.commodity_print)?1:0})),X=l((()=>{let e=0;return B.product_print_list.forEach((t=>{e+=t.pages_content.imgList.reduce(((e,t)=>"photo"==t.type?e+1:e),0)})),e})),Y=l((()=>{let e=0;return B.product_print_list.forEach((t=>{e+=t.pages_content.imgList.reduce(((e,t)=>"photo"==t.type&&t.url?e+1:e),0)})),e})),ee=l((()=>{var e,t,l,s;const i=(null==(t=null==(e=V.value)?void 0:e.order_spec_info_obj)?void 0:t.spec_number)||0,r=(null==(s=null==(l=V.value)?void 0:l.order_spec_info_obj)?void 0:s.spec_multiple)||1;return B.product_print_list.length>=100||(0==i||B.product_print_list.length>=i&&B.product_print_list.length%r==0)})),te=(e,t)=>{var l,s,i,r;B.cItem=e,B.cIndex=t;if(1==((null==(s=null==(l=V.value)?void 0:l.order_spec_info_obj)?void 0:s.spec_edit)||0)){const e=(null==(r=null==(i=V.value)?void 0:i.order_spec_info_obj)?void 0:r.spec_template_edit_mode)||0;1==e?f.goToPage("easy-edit",`pageInfo=${JSON.stringify(B.cItem)}`):2==e?f.goToPage("professional-edit",`pageInfo=${JSON.stringify(B.cItem)}`):f.showToast("所选页面只允许换图片")}else f.showToast("该模版只允许换图片")},le=()=>{if(V.value.order_id>0){if(V.value.order_status>0)return void f.showToast("该订单已经定稿，不能修改");se()}else ie()},se=()=>{var e;const t=JSON.parse(JSON.stringify(V.value)),l=[B.coverPage,...B.product_print_list,B.endPage];t.order_product_info_obj.product_print=JSON.stringify(l),t.order_product_info=JSON.stringify(t.order_product_info_obj),t.order_cover=(null==(e=t.order_spec_info_obj)?void 0:e.spec_cover)||"",t.order_custom_id=R.value.custom_id,t.order_frequency=Number(t.order_frequency)+1,c.updateOrder(t).then((e=>{B.showModal=0,f.showToast("提交成功"),setTimeout((()=>{f.reToPage("home")}),1800)}))},ie=()=>{var e;const t=JSON.parse(JSON.stringify(V.value)),l=[B.coverPage,...B.product_print_list,B.endPage];t.order_product_info_obj.product_print=JSON.stringify(l),t.order_product_info=JSON.stringify(t.order_product_info_obj),t.order_cover=(null==(e=t.order_spec_info_obj)?void 0:e.spec_cover)||"",t.order_custom_id=R.value.custom_id,c.addOrder(t).then((e=>{B.showModal=0,f.showToast("提交成功"),setTimeout((()=>{f.reToPage("home")}),1800)}))},re=(e,t)=>{v({count:1,sizeType:["original","compressed"],sourceType:["album"],success:l=>{const s=l.tempFilePaths[0];c.uploadFile({filePath:s,name:"file"}).then((l=>{"coverPage"==e?B.coverPage.pages_content.imgList[t].url=l.data.url:"endPage"==e?B.endPage.pages_content.imgList[t].url=l.data.url:B.product_print_list[e].pages_content.imgList[t].url=l.data.url}))}})},oe=()=>{if(Y.value>=X.value)return void f.showToast("图片位置已占满，请点击图片更换图片");const e=X.value-Y.value;v({count:e>9?9:e,sizeType:["original","compressed"],sourceType:["album"],success:async e=>{for(let t=0;t<e.tempFilePaths.length;t++){const l=await c.uploadFile({filePath:e.tempFilePaths[t],name:"file"});ae(l.data.url)}}})},ae=e=>{for(let t of B.product_print_list){let l=0;for(let s of t.pages_content.imgList)if("photo"==s.type&&""==s.url){s.url=e,l=1;break}if(1==l)break}};return O((()=>{})),T((e=>{var t,l;if(c.getConfigsById({configs_id:102}).then((e=>{B.configsInfo=e.data})),c.getConfigsById({configs_id:101}).then((e=>{B.configsInfo2=e.data})),null==(l=null==(t=V.value)?void 0:t.order_product_info_obj)?void 0:l.product_print){if(B.product_print_list=JSON.parse(V.value.order_product_info_obj.product_print),B.product_print_list.length>0){const e=s(344);B.product_print_list.forEach((t=>{t.bili=t.pages_area_width/e})),setPictureNumber(),B.coverPage=B.product_print_list[0],B.endPage=B.product_print_list[B.product_print_list.length-1],B.product_print_list.shift(),B.product_print_list.pop()}}else B.product_print_list=[];i("updatePageInfo",(e=>{(e=>{const t=s(344);e.bili=e.pages_area_width/t,"coverPage"==B.cIndex?B.coverPage=Object.assign({},e):"endPage"==B.cIndex?B.endPage=Object.assign({},e):B.product_print_list[B.cIndex]=Object.assign({},e)})(e)}))})),F((()=>{r("updatePageInfo")})),(e,t)=>{const l=w,s=$,i=k,r=N(j("tui-modal"),C),c=N(j("page"),I);return o(),a(c,{bgColor:"#fff",topColor:"#00AEEF",topHeight:88,bottomHeight:240,refresherEnabled:!1},{navBar:n((()=>[d(i,{class:"text-center flex align-center justify-center",style:{height:"88rpx"}},{default:n((()=>[d(l,{class:"font-36 text-white"},{default:n((()=>[u("无限模式商品模版编辑")])),_:1}),d(i,{onClick:t[0]||(t[0]=e=>p(f).goBack()),class:"position-absolute rounded-circle flex align-center justify-center",style:{width:"40rpx",height:"32rpx",left:"32rpx"}},{default:n((()=>[d(s,{style:{width:"40rpx",height:"32rpx"},src:S,mode:""})])),_:1})])),_:1})])),content:n((()=>[d(i,{class:"py-2"},{default:n((()=>[p(K).pages_id?(o(),a(i,{key:0,class:""},{default:n((()=>[d(i,{class:"flex flex-column align-center justify-center"},{default:n((()=>[d(i,{onClick:t[1]||(t[1]=e=>te(p(K),"coverPage")),class:"position-relative flex align-center justify-center",style:{width:"344rpx"}},{default:n((()=>{var e,t;return[(null==(t=null==(e=p(K))?void 0:e.pages_content)?void 0:t.bgImg)?(o(),a(s,{key:0,class:"border",style:{width:"344rpx"},src:p(f).showImageUrl(p(K).pages_content.bgImg),mode:"widthFix"},null,8,["src"])):_("",!0),d(i,{class:"position-absolute top-0 left-0 right-0 bottom-0"},{default:n((()=>[(o(!0),g(x,null,h(p(K).pages_content.imgList,((e,t)=>(o(),a(i,{key:t,class:""},{default:n((()=>["photo"==e.type?(o(),a(i,{key:0,onClick:P((e=>re("coverPage",t)),["stop"]),class:"position-absolute flex align-center justify-center overflow-hidden",style:b([{"background-color":"rgba(51, 102, 255, 0.2)"},`transform:scale(${e.scale}) rotate(${e.r||0}deg);border-radius: ${e.radius}px;top:${e.y/p(K).bili}px;left:${e.x/p(K).bili}px;width: ${e.width/p(K).bili}px; height:${e.height/p(K).bili}px;`])},{default:n((()=>[e.url?(o(),a(s,{key:0,style:b(`width: ${e.width/p(K).bili}px; height:${e.height/p(K).bili}px;`),src:p(f).showImageUrl(e.url),mode:"widthFix"},null,8,["style","src"])):(o(),a(l,{key:1,class:"text-primary font-40 font-weight-bold"},{default:n((()=>[u("+")])),_:1}))])),_:2},1032,["onClick","style"])):(o(),a(i,{key:1,class:"position-absolute"},{default:n((()=>[d(s,{class:"position-absolute",style:b(`transform:scale(${e.scale}) rotate(${e.r||0}deg);border-radius: ${e.radius}px;top:${e.y/p(K).bili}px;left:${e.x/p(K).bili}px;width: ${e.width/p(K).bili}px; height:${e.height/p(K).bili}px;`),src:p(f).showImageUrl(e.url),mode:""},null,8,["style","src"])])),_:2},1024))])),_:2},1024)))),128))])),_:1})]})),_:1}),d(i,{class:"flex align-center justify-center py-2 font-30 font-weight-bold"},{default:n((()=>[d(l,{class:"mx-1"},{default:n((()=>[u("封面")])),_:1})])),_:1})])),_:1})])),_:1})):_("",!0),d(i,{class:"px-1 py-2 flex flex-wrap"},{default:n((()=>[(o(!0),g(x,null,h(p(z),((e,t)=>(o(),a(i,{key:t,class:"m-1",style:{width:"344rpx"}},{default:n((()=>[d(i,{onClick:l=>te(e,t),class:"position-relative flex align-center justify-center",style:{width:"344rpx"}},{default:n((()=>{var r;return[(null==(r=null==e?void 0:e.pages_content)?void 0:r.bgImg)?(o(),a(s,{key:0,class:"border",style:{width:"344rpx"},src:p(f).showImageUrl(e.pages_content.bgImg),mode:"widthFix"},null,8,["src"])):_("",!0),d(i,{class:"position-absolute top-0 left-0 right-0 bottom-0"},{default:n((()=>[(o(!0),g(x,null,h(e.pages_content.imgList,((r,c)=>(o(),a(i,{key:c,class:""},{default:n((()=>["photo"==r.type?(o(),a(i,{key:0,onClick:P((e=>re(t,c)),["stop"]),class:"position-absolute border border-primary flex align-center justify-center overflow-hidden",style:b([{"background-color":"rgba(51, 102, 255, 0.2)"},`transform:scale(${r.scale}) rotate(${e.r||0}deg);border-radius: ${e.radius}px;top:${r.y/e.bili}px;left:${r.x/e.bili}px;width: ${r.width/e.bili}px; height:${r.height/e.bili}px;`])},{default:n((()=>[r.url?(o(),a(s,{key:0,style:b(`width: ${r.width/e.bili}px; height:${r.height/e.bili}px;`),src:p(f).showImageUrl(r.url),mode:"widthFix"},null,8,["style","src"])):(o(),a(l,{key:1,class:"text-primary font-40 font-weight-bold"},{default:n((()=>[u("+")])),_:1}))])),_:2},1032,["onClick","style"])):(o(),a(i,{key:1,class:"position-absolute"},{default:n((()=>[d(s,{class:"position-absolute",style:b(`transform:scale(${r.scale}) rotate(${e.r||0}deg);border-radius: ${e.radius}px;top:${r.y/e.bili}px;left:${r.x/e.bili}px;width: ${r.width/e.bili}px; height:${r.height/e.bili}px;`),src:p(f).showImageUrl(r.url),mode:""},null,8,["style","src"])])),_:2},1024))])),_:2},1024)))),128))])),_:2},1024),1==p(W)&&(t+1)%2==0?(o(),a(i,{key:1,class:"bg-opacity p-1 position-absolute right-0 top-0 flex align-center justify-center rounded-circle",style:{width:"60rpx",height:"30rpx"}},{default:n((()=>[d(l,{class:"font-20 text-white"},{default:n((()=>[u("反面")])),_:1})])),_:1})):_("",!0)]})),_:2},1032,["onClick"]),d(i,{class:"flex align-center justify-center py-2 font-30 font-weight-bold"},{default:n((()=>[d(s,{onClick:e=>(e=>{if(1==B.product_print_list.length)return f.showToast("只剩最后一页了，不能移除了！！！"),!1;B.product_print_list.splice(e,1)})(t),style:{width:"50rpx",height:"50rpx"},src:J,mode:""},null,8,["onClick"]),d(l,{class:"ml-2"},{default:n((()=>{var e,t;return[u(y(null==(t=null==(e=p(V))?void 0:e.order_spec_info_obj)?void 0:t.spec_page_prefix),1)]})),_:1}),d(l,{class:"mx-1"},{default:n((()=>[u(y(t+1),1)])),_:2},1024),d(l,{class:"mr-2"},{default:n((()=>{var e,t;return[u(y(null==(t=null==(e=p(V))?void 0:e.order_spec_info_obj)?void 0:t.spec_page_suffix),1)]})),_:1}),d(s,{onClick:t=>(e=>{const t=JSON.parse(JSON.stringify(e));t.pages_id=Math.random().toString(16).slice(2),B.product_print_list.push(t)})(e),style:{width:"50rpx",height:"50rpx"},src:L,mode:""},null,8,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:1}),p(Q).pages_id?(o(),a(i,{key:1,class:""},{default:n((()=>[d(i,{class:"flex flex-column align-center justify-center"},{default:n((()=>[d(i,{onClick:t[2]||(t[2]=e=>te(p(Q),"endPage")),class:"position-relative flex align-center justify-center",style:{width:"344rpx"}},{default:n((()=>{var e,t;return[(null==(t=null==(e=p(Q))?void 0:e.pages_content)?void 0:t.bgImg)?(o(),a(s,{key:0,class:"border",style:{width:"344rpx"},src:p(f).showImageUrl(p(Q).pages_content.bgImg),mode:"widthFix"},null,8,["src"])):_("",!0),d(i,{class:"position-absolute top-0 left-0 right-0 bottom-0"},{default:n((()=>[(o(!0),g(x,null,h(p(Q).pages_content.imgList,((e,t)=>(o(),a(i,{key:t,class:""},{default:n((()=>["photo"==e.type?(o(),a(i,{key:0,onClick:P((e=>re("endPage",t)),["stop"]),class:"position-absolute border border-primary flex align-center justify-center overflow-hidden",style:b([{"background-color":"rgba(51, 102, 255, 0.2)"},`transform:scale(${e.scale}) rotate(${e.r||0}deg);border-radius: ${e.radius}px;top:${e.y/p(Q).bili}px;left:${e.x/p(Q).bili}px;width: ${e.width/p(Q).bili}px; height:${e.height/p(Q).bili}px;`])},{default:n((()=>[e.url?(o(),a(s,{key:0,style:b(`width: ${e.width/p(Q).bili}px; height:${e.height/p(Q).bili}px;`),src:p(f).showImageUrl(e.url),mode:"widthFix"},null,8,["style","src"])):(o(),a(l,{key:1,class:"text-primary font-40 font-weight-bold"},{default:n((()=>[u("+")])),_:1}))])),_:2},1032,["onClick","style"])):(o(),a(i,{key:1,class:"position-absolute"},{default:n((()=>[d(s,{class:"position-absolute",style:b(`transform:scale(${e.scale}) rotate(${e.r||0}deg);border-radius: ${e.radius}px;top:${e.y/p(Q).bili}px;left:${e.x/p(Q).bili}px;width: ${e.width/p(Q).bili}px; height:${e.height/p(Q).bili}px;`),src:p(f).showImageUrl(e.url),mode:""},null,8,["style","src"])])),_:2},1024))])),_:2},1024)))),128))])),_:1})]})),_:1}),d(i,{class:"flex align-center justify-center py-2 font-30 font-weight-bold"},{default:n((()=>[d(l,{class:"mx-1"},{default:n((()=>[u("尾页")])),_:1})])),_:1})])),_:1})])),_:1})):_("",!0)])),_:1}),d(r,{show:1==p(H),custom:""},{default:n((()=>[d(i,{class:"rounded-20 bg-white border-box font pb-3",style:{width:"600rpx"}},{default:n((()=>[d(i,{class:"py-2 text-center"},{default:n((()=>[d(l,{class:"font-40 font-weight-bold"},{default:n((()=>[u("产品信息确认")])),_:1})])),_:1}),d(i,{class:"py-2 px-4 font-32"},{default:n((()=>[d(i,{class:"flex align-center py-1"},{default:n((()=>[d(i,{class:""},{default:n((()=>[d(l,{class:"text-color-999"},{default:n((()=>[u("产品：")])),_:1})])),_:1}),d(i,{class:"flex text-ellipsis"},{default:n((()=>[d(l,{class:"font-weight-bold"},{default:n((()=>{var e;return[u(y(null==(e=p(V))?void 0:e.order_commodity_name),1)]})),_:1})])),_:1})])),_:1}),d(i,{class:"flex align-center py-1"},{default:n((()=>[d(i,{class:""},{default:n((()=>[d(l,{class:"text-color-999"},{default:n((()=>[u("规格：")])),_:1})])),_:1}),d(i,{class:"flex text-ellipsis"},{default:n((()=>[d(l,{class:"font-weight-bold"},{default:n((()=>{var e;return[u(y(null==(e=p(V))?void 0:e.order_spec_name),1)]})),_:1})])),_:1})])),_:1}),d(i,{class:"flex align-center py-1"},{default:n((()=>[d(i,{class:""},{default:n((()=>[d(l,{class:"text-color-999"},{default:n((()=>[u("纸张：")])),_:1})])),_:1}),d(i,{class:"flex text-ellipsis"},{default:n((()=>[d(l,{class:"font-weight-bold"},{default:n((()=>{var e;return[u(y((null==(e=p(V))?void 0:e.order_material_name)||"系统提供纸张"),1)]})),_:1})])),_:1})])),_:1}),d(i,{class:"flex align-center py-2"},{default:n((()=>[d(s,{style:{width:"24rpx",height:"24rpx"},src:U,mode:"widthFix"}),d(i,{class:"ml-1 flex-1"},{default:n((()=>[d(l,{class:"text-warning font-24"},{default:n((()=>[u("核对产品信息，如有问题点击取消返回，核对无误点击确认")])),_:1})])),_:1})])),_:1})])),_:1}),d(i,{class:"px-5 flex align-center justify-center px-2"},{default:n((()=>[d(i,{onClick:t[3]||(t[3]=e=>H.value=0),class:"flex-1 flex align-center justify-center bg-info rounded-circle mr-2",style:{height:"80rpx"}},{default:n((()=>[d(l,{class:"text-white"},{default:n((()=>[u("取消")])),_:1})])),_:1}),d(i,{onClick:le,class:"flex-1 flex align-center justify-center linear-gradient rounded-circle ml-2",style:{height:"80rpx"}},{default:n((()=>[d(l,{class:"text-white"},{default:n((()=>[u("确定")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["show"])])),bottomBar:n((()=>[d(i,{class:"flex align-center justify-center text-ellipsis px-1",style:b([`background-color:${p(G).configs_content}; color:${p(G).configs_illustrate};font-size: ${p(G).configs_use||28}rpx;`,{width:"750rpx",height:"60rpx"}])},{default:n((()=>[d(l,{class:"text-ellipsis text-center"},{default:n((()=>[u(y(p(G).configs_value),1)])),_:1})])),_:1},8,["style"]),d(i,{class:"flex align-center justify-center text-ellipsis px-1",style:b([`background-color:${p(A).configs_content}; color:${p(A).configs_illustrate};font-size: ${p(A).configs_use||28}rpx;`,{width:"750rpx",height:"60rpx"}])},{default:n((()=>[d(l,{class:"text-ellipsis text-center"},{default:n((()=>{var e,t;return[u(y(null==(t=null==(e=p(V))?void 0:e.order_spec_info_obj)?void 0:t.spec_prompt),1)]})),_:1})])),_:1},8,["style"]),d(i,{class:"bg-white flex align-center justify-center px-2",style:{height:"120rpx"}},{default:n((()=>[d(i,{onClick:oe,class:"flex-1 flex align-center justify-center bg-warning rounded-circle mr-1",style:{height:"90rpx"}},{default:n((()=>[d(l,{class:"text-white"},{default:n((()=>[u("上传图片("+y(p(Y))+"/"+y(p(X))+")",1)])),_:1})])),_:1}),p(ee)?(o(),a(i,{key:0,onClick:t[4]||(t[4]=e=>H.value=1),class:"flex-1 flex align-center justify-center linear-gradient rounded-circle ml-1",style:{height:"90rpx"}},{default:n((()=>[d(l,{class:"text-white"},{default:n((()=>[u("制作完成")])),_:1})])),_:1})):(o(),a(i,{key:1,onClick:t[5]||(t[5]=e=>H.value=1),class:"flex-1 flex align-center justify-center bg-info rounded-circle ml-1",style:{height:"90rpx"}},{default:n((()=>[d(l,{class:"text-white"},{default:n((()=>[u("未达定制倍数")])),_:1})])),_:1}))])),_:1})])),_:1})}}},[["__scopeId","data-v-0f4736f5"]]);export{B as default};
