import{r as e,t,aa as l,af as s,ag as i,ah as r,o,c as a,w as n,e as c,a as d,b as u,u as p,d as f,p as _,l as g,m as h,F as x,v as b,n as y,s as m,y as w,h as v,i as $,g as k,j,_ as I,Z as P}from"./index-855f89f9.js";import{_ as C}from"./tui-modal.dd985726.js";import{a as N,o as F,b as O,r as T}from"./uni-app.es.8f4863ce.js";import{_ as J}from"./back_bai.3f7a0c49.js";import{_ as L}from"./gg.7b849707.js";import{_ as S}from"./_plugin-vue_export-helper.1b428a4d.js";const U=S({__name:"product-book-edit",setup(S){const U=e({triggered:!1,product_print_list:[],bili:1,showModal:0,pictureNumber:1,configsInfo:{},cItem:{},cIndex:0,coverPage:{pages_id:"",pages_cover:"",pages_content:{bgImg:"",imgList:[]}},endPage:{pages_id:"",pages_cover:"",pages_content:{bgImg:"",imgList:[]}}}),{triggered:E,product_print_list:B,bili:M,showModal:z,pictureNumber:q,configsInfo:H,cItem:A,cIndex:Z,coverPage:D,endPage:G}=t(U),K=l((()=>m.state.userInfo)),Q=l((()=>m.state.orderFrom)),R=l((()=>{var e,t;return 1==(null==(t=null==(e=Q.value)?void 0:e.order_commodity_info_obj)?void 0:t.commodity_print)?1:0})),V=l((()=>{let e=0;return U.product_print_list.forEach((t=>{e+=t.pages_content.imgList.reduce(((e,t)=>"photo"==t.type&&t.url?e+1:e),0)})),e})),W=(e,t)=>{var l,s,i,r;U.cItem=e,U.cIndex=t;if(1==((null==(s=null==(l=Q.value)?void 0:l.order_spec_info_obj)?void 0:s.spec_edit)||0)){const e=(null==(r=null==(i=Q.value)?void 0:i.order_spec_info_obj)?void 0:r.spec_template_edit_mode)||0;1==e?f.goToPage("easy-edit",`pageInfo=${JSON.stringify(U.cItem)}`):2==e?f.goToPage("professional-edit",`pageInfo=${JSON.stringify(U.cItem)}`):f.showToast("所选页面只允许换图片")}else f.showToast("该模版只允许换图片")},X=()=>{if(Q.value.order_id>0){if(Q.value.order_status>0)return void f.showToast("该订单已经定稿，不能修改");Y()}else ee()},Y=()=>{var e;const t=JSON.parse(JSON.stringify(Q.value)),l=[U.coverPage,...U.product_print_list,U.endPage];t.order_product_info_obj.product_print=JSON.stringify(l),t.order_product_info=JSON.stringify(t.order_product_info_obj),t.order_cover=(null==(e=t.order_spec_info_obj)?void 0:e.spec_cover)||"",t.order_custom_id=K.value.custom_id,t.order_frequency=Number(t.order_frequency)+1,c.updateOrder(t).then((e=>{U.showModal=0,f.showToast("提交成功"),setTimeout((()=>{f.reToPage("home")}),1800)}))},ee=()=>{var e;const t=JSON.parse(JSON.stringify(Q.value)),l=[U.coverPage,...U.product_print_list,U.endPage];t.order_product_info_obj.product_print=JSON.stringify(l),t.order_product_info=JSON.stringify(t.order_product_info_obj),t.order_cover=(null==(e=t.order_spec_info_obj)?void 0:e.spec_cover)||"",t.order_custom_id=K.value.custom_id,c.addOrder(t).then((e=>{U.showModal=0,f.showToast("提交成功"),setTimeout((()=>{f.reToPage("home")}),1800)}))},te=(e,t)=>{w({count:1,sizeType:["original","compressed"],sourceType:["album"],success:l=>{const s=l.tempFilePaths[0];c.uploadFile({filePath:s,name:"file"}).then((l=>{"coverPage"==e?U.coverPage.pages_content.imgList[t].url=l.data.url:"endPage"==e?U.endPage.pages_content.imgList[t].url=l.data.url:U.product_print_list[e].pages_content.imgList[t].url=l.data.url}))}})},le=()=>{if(V.value>=U.pictureNumber)return void f.showToast("图片位置已占满，请点击图片更换图片");const e=U.pictureNumber-V.value;w({count:e>9?9:e,sizeType:["original","compressed"],sourceType:["album"],success:async e=>{for(let t=0;t<e.tempFilePaths.length;t++){const l=await c.uploadFile({filePath:e.tempFilePaths[t],name:"file"});se(l.data.url)}}})},se=e=>{for(let t of U.product_print_list){let l=0;for(let s of t.pages_content.imgList)if("photo"==s.type&&""==s.url){s.url=e,l=1,console.log("item2.url",s.url);break}if(1==l)break}};return N((()=>{})),F((e=>{var t,l;if(c.getConfigsById({configs_id:102}).then((e=>{U.configsInfo=e.data})),null==(l=null==(t=Q.value)?void 0:t.order_product_info_obj)?void 0:l.product_print){if(U.product_print_list=JSON.parse(Q.value.order_product_info_obj.product_print),U.product_print_list.length>0){const e=s(344);U.product_print_list.forEach((t=>{console.log("item",t),t.bili=t.pages_area_width/e})),(()=>{let e=0;U.product_print_list.forEach((t=>{e+=t.pages_content.imgList.reduce(((e,t)=>"photo"==t.type?e+1:e),0)})),U.pictureNumber=e})(),U.coverPage=U.product_print_list[0],U.endPage=U.product_print_list[U.product_print_list.length-1],U.product_print_list.shift(),U.product_print_list.pop()}}else U.product_print_list=[];i("updatePageInfo",(e=>{(e=>{const t=s(344);e.bili=e.pages_area_width/t,"coverPage"==U.cIndex?U.coverPage=Object.assign({},e):"endPage"==U.cIndex?U.endPage=Object.assign({},e):U.product_print_list[U.cIndex]=Object.assign({},e)})(e)}))})),O((()=>{r("updatePageInfo")})),(e,t)=>{const l=v,s=$,i=k,r=T(j("tui-modal"),C),c=T(j("page"),I);return o(),a(c,{bgColor:"#fff",topColor:"#00AEEF",topHeight:88,bottomHeight:180,refresherEnabled:!1},{navBar:n((()=>[d(i,{class:"text-center flex align-center justify-center",style:{height:"88rpx"}},{default:n((()=>[d(l,{class:"font-36 text-white"},{default:n((()=>[u("书籍模版编辑")])),_:1}),d(i,{onClick:t[0]||(t[0]=e=>p(f).goBack()),class:"position-absolute rounded-circle flex align-center justify-center",style:{width:"40rpx",height:"32rpx",left:"32rpx"}},{default:n((()=>[d(s,{style:{width:"40rpx",height:"32rpx"},src:J,mode:""})])),_:1})])),_:1})])),content:n((()=>[d(i,{class:"py-2"},{default:n((()=>[p(D).pages_id?(o(),a(i,{key:0,class:""},{default:n((()=>[d(i,{class:"flex flex-column align-center justify-center"},{default:n((()=>[d(i,{onClick:t[1]||(t[1]=e=>W(p(D),"coverPage")),class:"position-relative flex align-center justify-center border border-primary",style:{width:"344rpx"}},{default:n((()=>{var e,t;return[(null==(t=null==(e=p(D))?void 0:e.pages_content)?void 0:t.bgImg)?(o(),a(s,{key:0,class:"border",style:{width:"344rpx"},src:p(f).showImageUrl(p(D).pages_content.bgImg),mode:"widthFix"},null,8,["src"])):_("",!0),d(i,{class:"position-absolute top-0 left-0 right-0 bottom-0"},{default:n((()=>[(o(!0),g(x,null,h(p(D).pages_content.imgList,((e,t)=>(o(),a(i,{key:t,class:"position-absolute top-0 left-0"},{default:n((()=>["photo"==e.type?(o(),a(i,{key:0,onClick:P((e=>te("coverPage",t)),["stop"]),class:"position-absolute flex align-center justify-center overflow-hidden",style:y([{"background-color":"rgba(51, 102, 255, 0.2)"},`transform: scale(${e.scale}) rotate(${e.r||0}deg);border-radius: ${e.radius}px;top:${e.y/p(D).bili}px;left:${e.x/p(D).bili}px;width: ${e.width/p(D).bili}px; height:${e.height/p(D).bili}px;`])},{default:n((()=>[e.url?(o(),a(s,{key:0,style:y(`width: ${e.width/p(D).bili}px; height:${e.height/p(D).bili}px;`),src:p(f).showImageUrl(e.url),mode:"widthFix"},null,8,["style","src"])):(o(),a(l,{key:1,class:"text-primary font-40"},{default:n((()=>[u("+")])),_:1}))])),_:2},1032,["onClick","style"])):(o(),a(i,{key:1,class:"position-absolute"},{default:n((()=>[d(s,{class:"position-absolute",style:y(`transform:scale(${e.scale}) rotate(${e.r||0}deg);border-radius: ${e.radius}px;top:${e.y/p(D).bili}px;left:${e.x/p(D).bili}px;width: ${e.width/p(D).bili}px; height:${e.height/p(D).bili}px;`),src:p(f).showImageUrl(e.url),mode:""},null,8,["style","src"])])),_:2},1024))])),_:2},1024)))),128))])),_:1})]})),_:1}),d(i,{class:"flex align-center justify-center py-2 font-30 font-weight-bold"},{default:n((()=>[d(l,{class:"mx-1"},{default:n((()=>[u("封面")])),_:1})])),_:1})])),_:1})])),_:1})):_("",!0),d(i,{class:"px-1 py-2 flex flex-wrap"},{default:n((()=>[(o(!0),g(x,null,h(p(B),((e,t)=>(o(),a(i,{key:t,class:"m-1",style:{width:"344rpx"}},{default:n((()=>[d(i,{onClick:l=>W(e,t),class:"position-relative flex align-center justify-center",style:{width:"344rpx"}},{default:n((()=>{var r;return[(null==(r=null==e?void 0:e.pages_content)?void 0:r.bgImg)?(o(),a(s,{key:0,class:"border",style:{width:"344rpx"},src:p(f).showImageUrl(e.pages_content.bgImg),mode:"widthFix"},null,8,["src"])):_("",!0),d(i,{class:"position-absolute top-0 left-0 right-0 bottom-0"},{default:n((()=>[(o(!0),g(x,null,h(e.pages_content.imgList,((r,c)=>(o(),a(i,{key:c,class:""},{default:n((()=>["photo"==r.type?(o(),a(i,{key:0,onClick:P((e=>te(t,c)),["stop"]),class:"position-absolute flex align-center justify-center overflow-hidden",style:y([{"background-color":"rgba(51, 102, 255, 0.2)"},`transform: scale(${r.scale}) rotate(${r.r||0}deg);border-radius: ${r.radius}px;top:${r.y/e.bili}px;left:${r.x/e.bili}px;width: ${r.width/e.bili}px; height:${r.height/e.bili}px;`])},{default:n((()=>[r.url?(o(),a(s,{key:0,style:y(`width: ${r.width/e.bili}px; height:${r.height/e.bili}px;`),src:p(f).showImageUrl(r.url),mode:"widthFix"},null,8,["style","src"])):(o(),a(l,{key:1,class:"text-primary font-40 font-weight-bold"},{default:n((()=>[u("+")])),_:1}))])),_:2},1032,["onClick","style"])):(o(),a(i,{key:1,class:"position-absolute"},{default:n((()=>[d(s,{class:"position-absolute",style:y(`transform:scale(${r.scale}) rotate(${r.r||0}deg);border-radius: ${r.radius}px;top:${r.y/e.bili}px;left:${r.x/e.bili}px;width: ${r.width/e.bili}px; height:${r.height/e.bili}px;`),src:p(f).showImageUrl(r.url),mode:""},null,8,["style","src"])])),_:2},1024))])),_:2},1024)))),128))])),_:2},1024),1==p(R)&&(t+1)%2==0?(o(),a(i,{key:1,class:"bg-opacity p-1 position-absolute right-0 top-0 flex align-center justify-center rounded-circle",style:{width:"60rpx",height:"30rpx"}},{default:n((()=>[d(l,{class:"font-20 text-white"},{default:n((()=>[u("反面")])),_:1})])),_:1})):_("",!0)]})),_:2},1032,["onClick"]),d(i,{class:"flex align-center justify-center py-2 font-30 font-weight-bold"},{default:n((()=>[d(l,{class:"ml-2"},{default:n((()=>{var e,t;return[u(b(null==(t=null==(e=p(Q))?void 0:e.order_spec_info_obj)?void 0:t.spec_page_prefix),1)]})),_:1}),d(l,{class:"mx-1"},{default:n((()=>[u(b(t+1),1)])),_:2},1024),d(l,{class:"mr-2"},{default:n((()=>{var e,t;return[u(b(null==(t=null==(e=p(Q))?void 0:e.order_spec_info_obj)?void 0:t.spec_page_suffix),1)]})),_:1})])),_:2},1024)])),_:2},1024)))),128))])),_:1}),p(G).pages_id?(o(),a(i,{key:1,class:""},{default:n((()=>[d(i,{class:"flex flex-column align-center justify-center"},{default:n((()=>[d(i,{onClick:t[2]||(t[2]=e=>W(p(G),"endPage")),class:"position-relative flex align-center justify-center",style:{width:"344rpx"}},{default:n((()=>{var e,t;return[(null==(t=null==(e=p(G))?void 0:e.pages_content)?void 0:t.bgImg)?(o(),a(s,{key:0,class:"border",style:{width:"344rpx"},src:p(f).showImageUrl(p(G).pages_content.bgImg),mode:"widthFix"},null,8,["src"])):_("",!0),d(i,{class:"position-absolute top-0 left-0 right-0 bottom-0"},{default:n((()=>[(o(!0),g(x,null,h(p(G).pages_content.imgList,((e,t)=>(o(),a(i,{key:t,class:""},{default:n((()=>["photo"==e.type?(o(),a(i,{key:0,onClick:P((e=>te("endPage",t)),["stop"]),class:"position-absolute border border-primary flex align-center justify-center overflow-hidden",style:y([{"background-color":"rgba(51, 102, 255, 0.2)"},`transform:scale(${e.scale}) rotate(${e.r||0}deg);border-radius: ${e.radius}px;top:${e.y/p(G).bili}px;left:${e.x/p(G).bili}px;width: ${e.width/p(G).bili}px; height:${e.height/p(G).bili}px;`])},{default:n((()=>[e.url?(o(),a(s,{key:0,style:y(`width: ${e.width/p(G).bili}px; height:${e.height/p(G).bili}px;`),src:p(f).showImageUrl(e.url),mode:"widthFix"},null,8,["style","src"])):(o(),a(l,{key:1,class:"text-primary font-40 font-weight-bold"},{default:n((()=>[u("+")])),_:1}))])),_:2},1032,["onClick","style"])):(o(),a(i,{key:1,class:"position-absolute"},{default:n((()=>[d(s,{class:"position-absolute",style:y(`transform:scale(${e.scale}) rotate(${e.r||0}deg);border-radius: ${e.radius}px;top:${e.y/p(G).bili}px;left:${e.x/p(G).bili}px;width: ${e.width/p(G).bili}px; height:${e.height/p(G).bili}px;`),src:p(f).showImageUrl(e.url),mode:""},null,8,["style","src"])])),_:2},1024))])),_:2},1024)))),128))])),_:1})]})),_:1}),d(i,{class:"flex align-center justify-center py-2 font-30 font-weight-bold"},{default:n((()=>[d(l,{class:"mx-1"},{default:n((()=>[u("尾页")])),_:1})])),_:1})])),_:1})])),_:1})):_("",!0)])),_:1}),d(r,{show:1==p(z),custom:""},{default:n((()=>[d(i,{class:"rounded-20 bg-white border-box font pb-3",style:{width:"600rpx"}},{default:n((()=>[d(i,{class:"py-2 text-center"},{default:n((()=>[d(l,{class:"font-40 font-weight-bold"},{default:n((()=>[u("产品信息确认")])),_:1})])),_:1}),d(i,{class:"py-2 px-4 font-32"},{default:n((()=>[d(i,{class:"flex align-center py-1"},{default:n((()=>[d(i,{class:""},{default:n((()=>[d(l,{class:"text-color-999"},{default:n((()=>[u("产品：")])),_:1})])),_:1}),d(i,{class:"flex text-ellipsis"},{default:n((()=>[d(l,{class:"font-weight-bold"},{default:n((()=>{var e;return[u(b(null==(e=p(Q))?void 0:e.order_commodity_name),1)]})),_:1})])),_:1})])),_:1}),d(i,{class:"flex align-center py-1"},{default:n((()=>[d(i,{class:""},{default:n((()=>[d(l,{class:"text-color-999"},{default:n((()=>[u("规格：")])),_:1})])),_:1}),d(i,{class:"flex text-ellipsis"},{default:n((()=>[d(l,{class:"font-weight-bold"},{default:n((()=>{var e;return[u(b(null==(e=p(Q))?void 0:e.order_spec_name),1)]})),_:1})])),_:1})])),_:1}),d(i,{class:"flex align-center py-1"},{default:n((()=>[d(i,{class:""},{default:n((()=>[d(l,{class:"text-color-999"},{default:n((()=>[u("纸张：")])),_:1})])),_:1}),d(i,{class:"flex text-ellipsis"},{default:n((()=>[d(l,{class:"font-weight-bold"},{default:n((()=>{var e;return[u(b(null==(e=p(Q))?void 0:e.order_material_name),1)]})),_:1})])),_:1})])),_:1}),d(i,{class:"flex align-center py-2"},{default:n((()=>[d(s,{style:{width:"24rpx",height:"24rpx"},src:L,mode:"widthFix"}),d(i,{class:"ml-1 flex-1"},{default:n((()=>[d(l,{class:"text-warning font-24"},{default:n((()=>[u("核对产品信息，如有问题点击取消返回，核对无误点击确认")])),_:1})])),_:1})])),_:1})])),_:1}),d(i,{class:"px-5 flex align-center justify-center px-2"},{default:n((()=>[d(i,{onClick:t[3]||(t[3]=e=>z.value=0),class:"flex-1 flex align-center justify-center bg-info rounded-circle mr-2",style:{height:"80rpx"}},{default:n((()=>[d(l,{class:"text-white"},{default:n((()=>[u("取消")])),_:1})])),_:1}),d(i,{onClick:X,class:"flex-1 flex align-center justify-center linear-gradient rounded-circle ml-2",style:{height:"80rpx"}},{default:n((()=>[d(l,{class:"text-white"},{default:n((()=>[u("确定")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["show"])])),bottomBar:n((()=>[d(i,{class:"flex align-center justify-center text-ellipsis px-1",style:y([`background-color:${p(H).configs_content}; color:${p(H).configs_illustrate};font-size: ${p(H).configs_use||28}rpx;`,{width:"750rpx",height:"60rpx"}])},{default:n((()=>[d(l,{class:"text-ellipsis text-center"},{default:n((()=>{var e,t;return[u(b(null==(t=null==(e=p(Q))?void 0:e.order_spec_info_obj)?void 0:t.spec_prompt),1)]})),_:1})])),_:1},8,["style"]),d(i,{class:"bg-white flex align-center justify-center px-2",style:{height:"120rpx"}},{default:n((()=>[d(i,{onClick:le,class:"flex-1 flex align-center justify-center bg-warning rounded-circle mr-1",style:{height:"90rpx"}},{default:n((()=>[d(l,{class:"text-white"},{default:n((()=>[u("上传图片("+b(p(V))+"/"+b(p(q))+")",1)])),_:1})])),_:1}),d(i,{onClick:t[4]||(t[4]=e=>z.value=1),class:"flex-1 flex align-center justify-center linear-gradient rounded-circle ml-1",style:{height:"90rpx"}},{default:n((()=>[d(l,{class:"text-white"},{default:n((()=>[u("制作完成")])),_:1})])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-6408150e"]]);export{U as default};
